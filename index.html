<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The QR Project Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>body { font-family: 'Pretendard', sans-serif; }</style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const IconWrapper = ({ name, size = 24, className, ...props }) => {
            const iconName = name.charAt(0).toLowerCase() + name.slice(1);
            React.useEffect(() => { lucide.createIcons(); }, []);
            return <i data-lucide={iconName} className={className} style={{ width: size, height: size }} {...props}></i>;
        };
        const Search = (p) => <IconWrapper name="search" {...p} />;
        const Filter = (p) => <IconWrapper name="filter" {...p} />;
        const Briefcase = (p) => <IconWrapper name="briefcase" {...p} />;
        const CheckCircle2 = (p) => <IconWrapper name="checkCircle2" {...p} />;
        const DollarSign = (p) => <IconWrapper name="dollarSign" {...p} />;
        const Building2 = (p) => <IconWrapper name="building2" {...p} />;
        const MoreHorizontal = (p) => <IconWrapper name="moreHorizontal" {...p} />;
        const LayoutGrid = (p) => <IconWrapper name="layoutGrid" {...p} />;
        const TableIcon = (p) => <IconWrapper name="table" {...p} />;
        const Wallet = (p) => <IconWrapper name="wallet" {...p} />;
        const Archive = (p) => <IconWrapper name="archive" {...p} />;
        const Settings = (p) => <IconWrapper name="settings" {...p} />;
        const RefreshCw = (p) => <IconWrapper name="refreshCw" {...p} />;
        const AlertCircle = (p) => <IconWrapper name="alertCircle" {...p} />;
        const X = (p) => <IconWrapper name="x" {...p} />;
        const CreditCard = (p) => <IconWrapper name="creditCard" {...p} />;
        const UserCircle = (p) => <IconWrapper name="userCircle" {...p} />;

        const parseCSV = (text) => {
          const lines = text.split('\n').filter(line => line.trim() !== '');
          if (lines.length < 2) return [];
          const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          
          const keyMap = {
            '파일번호': 'fileNo', '구분': 'type', '담당자': 'manager', '거래처': 'client',
            '프로젝트명': 'project', '공급업체': 'supplier', '계약금액': 'amount',
            '계약일': 'contractDate', '착수일': 'startDate', '종료일': 'endDate',
            '선금_정산일': 'downPay_date', '선금_금액': 'downPay_amount', '선금_상태': 'downPay_status', '선금_계산서': 'downPay_tax',
            '중도금_정산일': 'midPay_date', '중도금_금액': 'midPay_amount', '중도금_상태': 'midPay_status', '중도금_계산서': 'midPay_tax',
            '잔금_정산일': 'balance_date', '잔금_금액': 'balance_amount', '잔금_상태': 'balance_status', '잔금_계산서': 'balance_tax'
          };

          const result = [];
          for (let i = 1; i < lines.length; i++) {
            let row = [];
            let match;
            const regex = /(?:^|,)(?:"([^"]*)"|([^",]*))/g;
            let line = lines[i];
            while ((match = regex.exec(line)) !== null && match.index < line.length) {
              row.push((match[1] || match[2] || '').trim());
            }
            if (row.length > 0) {
              const obj = { id: i, downPay: {}, midPay: {}, balance: {} };
              let hasData = false;
              headers.forEach((header, index) => {
                const key = keyMap[header] || header;
                let value = row[index];
                if (key.includes('amount')) value = parseInt(value?.replace(/[^0-9-]/g, '') || '0', 10);
                if (value) hasData = true;
                if (key.includes('_')) {
                    const [p, c] = key.split('_');
                    if (obj[p]) obj[p][c] = value;
                } else {
                    obj[key] = value;
                }
              });
              if (hasData) result.push(obj);
            }
          }
          return result;
        };

        const formatCurrency = (amt) => (amt === 0 || isNaN(amt)) ? '-' : new Intl.NumberFormat('ko-KR').format(amt);

        const Badge = ({ label, type }) => {
            if (!label) return null;
            const styles = {
                '입금': 'bg-indigo-50 text-indigo-700 ring-1 ring-indigo-600/20',
                '지출': 'bg-rose-50 text-rose-700 ring-1 ring-rose-600/20',
                '미확정': 'bg-slate-100 text-slate-600 ring-1 ring-slate-500/20',
                '정산 완료': 'bg-blue-50 text-blue-700 ring-1 ring-blue-600/20',
                '신청 완료': 'bg-amber-50 text-amber-700 ring-1 ring-amber-600/20',
                '미정산': 'bg-slate-50 text-slate-400 ring-1 ring-slate-200',
                '발행 완료': 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-600/20',
                '카드 결제': 'bg-purple-50 text-purple-700 ring-1 ring-purple-600/20',
                '더큐알': 'bg-slate-800 text-white',
                '더블제이스튜디오': 'bg-white text-slate-800 border border-slate-300',
                'manager': 'bg-slate-100 text-slate-700 border border-slate-200',
            };
            let s = styles[label] || 'bg-slate-50 text-slate-600 ring-1 ring-slate-600/20';
            if (type === 'manager') s = styles['manager'];
            return <span className={`px-2 py-0.5 rounded text-[10px] font-bold inline-flex items-center gap-1 ${s}`}>{type === 'manager' && <UserCircle size={10} />}{label}</span>;
        };

        const PaymentCell = ({ data }) => {
            if (!data || data.amount === 0) return <div className="text-center text-slate-200">-</div>;
            return (
                <div className="flex flex-col gap-1 text-right">
                    <span className="font-bold text-slate-700">{formatCurrency(data.amount)}</span>
                    <div className="flex justify-end gap-1 flex-wrap"><Badge label={data.status} /><Badge label={data.tax} /></div>
                    {data.date && <span className="text-[10px] text-slate-400 font-mono mt-0.5">{data.date}</span>}
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, sheetUrls, setSheetUrls, onSave }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-xl overflow-hidden flex flex-col">
                <div className="p-5 border-b border-slate-100 flex justify-between items-center">
                  <h2 className="text-lg font-bold flex items-center gap-2"><Settings className="text-indigo-600" size={20} /> 데이터 연동 설정</h2>
                  <button onClick={onClose}><X size={24} className="text-slate-400 hover:text-slate-600" /></button>
                </div>
                <div className="p-5 space-y-4">
                  <div className="bg-indigo-50 border border-indigo-100 rounded-lg p-3 text-xs text-indigo-800">
                    <strong>Tip:</strong> 구글 시트 링크(URL)를 아래에 붙여넣고 저장하세요.
                  </div>
                  {[0, 1, 2].map((idx) => (
                    <div key={idx} className="flex gap-2 items-center">
                      <span className="w-5 h-5 flex items-center justify-center rounded-full bg-slate-100 text-xs font-bold">{idx + 1}</span>
                      <input type="text" className="flex-1 border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                        placeholder="https://docs.google.com/.../pub?output=csv"
                        value={sheetUrls[idx] || ''} onChange={(e) => { const n = [...sheetUrls]; n[idx] = e.target.value; setSheetUrls(n); }} />
                    </div>
                  ))}
                </div>
                <div className="p-5 border-t bg-slate-50 flex justify-end gap-2">
                  <button onClick={onClose} className="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 text-sm">취소</button>
                  <button onClick={onSave} className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 text-sm flex gap-1 items-center"><CheckCircle2 size={16} /> 저장</button>
                </div>
              </div>
            </div>
          );
        };

        function App() {
          const [data, setData] = useState([]);
          const [viewMode, setViewMode] = useState('table');
          const [searchTerm, setSearchTerm] = useState('');
          const [filters, setFilters] = useState({ type: 'all', manager: 'all', supplier: 'all', payStatus: 'all', taxStatus: 'all', startDate: '', endDate: '' });
          const [isSettingsOpen, setIsSettingsOpen] = useState(false);
          const [sheetUrls, setSheetUrls] = useState(['', '', '']);
          const [loading, setLoading] = useState(false);
          const [lastUpdated, setLastUpdated] = useState(null);
          const [errorMsg, setErrorMsg] = useState('');

          useEffect(() => {
            const saved = localStorage.getItem('qr_dashboard_urls');
            if (saved) {
                const urls = JSON.parse(saved);
                setSheetUrls(urls);
                if (urls.some(u => u)) setTimeout(fetchSheetData, 500);
            }
          }, []);

          const fetchSheetData = async () => {
            const validUrls = sheetUrls.filter(u => u && u.includes('output=csv'));
            if (validUrls.length === 0) { setData([]); return; }

            setLoading(true); setErrorMsg('');
            try {
              // ★ 핵심 수정: 더 안정적인 프록시(corsproxy.io) 사용
              const promises = validUrls.map(url => 
                fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`)
                .then(res => {
                    if (!res.ok) throw new Error('응답 실패');
                    return res.text();
                })
              );
              
              const results = await Promise.all(promises);
              let allData = [];
              results.forEach(csv => allData = [...allData, ...parseCSV(csv)]);
              
              if (allData.length > 0) { setData(allData); setLastUpdated(new Date()); } 
              else setErrorMsg('데이터 없음: 시트에 내용이 있는지 확인해주세요.');

            } catch (err) {
              console.error(err);
              setErrorMsg('연결 실패: 잠시 후 다시 시도하거나 URL을 확인해주세요.');
            } finally { setLoading(false); }
          };

          const handleSaveSettings = () => {
            localStorage.setItem('qr_dashboard_urls', JSON.stringify(sheetUrls));
            setIsSettingsOpen(false);
            fetchSheetData();
          };

          const filteredData = useMemo(() => {
            return data.filter(item => {
              const s = searchTerm.toLowerCase();
              if (!((item.project||'').toLowerCase().includes(s) || (item.client||'').toLowerCase().includes(s))) return false;
              if (filters.type !== 'all' && item.type !== filters.type) return false;
              if (filters.manager !== 'all' && item.manager !== filters.manager) return false;
              if (filters.supplier !== 'all' && item.supplier !== filters.supplier) return false;
              
              if (filters.payStatus !== 'all') {
                 if (![item.downPay?.status, item.midPay?.status, item.balance?.status].includes(filters.payStatus)) return false;
              }
              if (filters.taxStatus !== 'all') {
                 if (![item.downPay?.tax, item.midPay?.tax, item.balance?.tax].includes(filters.taxStatus)) return false;
              }
              if (filters.startDate && item.contractDate < filters.startDate) return false;
              if (filters.endDate && item.contractDate > filters.endDate) return false;
              return true;
            });
          }, [data, searchTerm, filters]);

          const stats = useMemo(() => ({
            total: filteredData.length,
            revenue: filteredData.filter(i => i.type === '입금').reduce((a, c) => a + (c.amount || 0), 0),
            expense: filteredData.filter(i => i.type === '지출').reduce((a, c) => a + (c.amount || 0), 0),
            receivable: filteredData.filter(i => i.type === '입금').reduce((a, c) => a + (c.balance?.status !== '정산 완료' ? (c.balance?.amount||0) : 0), 0)
          }), [filteredData]);

          useEffect(() => { lucide.createIcons(); });

          return (
            <div className="min-h-screen p-4 md:p-8 font-sans text-slate-800">
              <SettingsModal isOpen={isSettingsOpen} onClose={()=>setIsSettingsOpen(false)} sheetUrls={sheetUrls} setSheetUrls={setSheetUrls} onSave={handleSaveSettings} />
              
              <header className="mb-8 flex flex-col md:flex-row justify-between gap-6 md:items-end">
                <div>
                   <span className="text-xs font-bold text-indigo-600 uppercase tracking-wider block mb-1">The QR Project Management</span>
                   <h1 className="text-3xl font-extrabold flex items-center gap-2">통합 대시보드 {loading && <RefreshCw className="animate-spin text-slate-400" size={20} />}</h1>
                   <div className="flex items-center gap-2 mt-2 text-sm text-slate-500">
                     <span>{lastUpdated ? `Updated: ${lastUpdated.toLocaleTimeString()}` : '데이터를 불러와주세요'}</span>
                   </div>
                   {errorMsg && <div className="mt-2 text-rose-600 text-xs font-bold flex items-center gap-1"><AlertCircle size={12}/>{errorMsg}</div>}
                </div>
                <div className="flex gap-2">
                    <button onClick={()=>setIsSettingsOpen(true)} className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border hover:bg-slate-50 text-sm font-bold"><Settings size={16}/> 설정</button>
                    <button onClick={fetchSheetData} className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border hover:bg-slate-50 text-sm font-bold"><RefreshCw size={16} className={loading?'animate-spin':''}/> 새로고침</button>
                </div>
              </header>

              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                 {[
                    { l: '전체 프로젝트', v: `${stats.total}건`, i: Briefcase, c: 'text-slate-600', b: 'bg-slate-100' },
                    { l: '총 매출', v: new Intl.NumberFormat('ko-KR', { notation:"compact" }).format(stats.revenue), i: DollarSign, c: 'text-indigo-600', b: 'bg-indigo-50' },
                    { l: '총 지출', v: new Intl.NumberFormat('ko-KR', { notation:"compact" }).format(stats.expense), i: CreditCard, c: 'text-rose-600', b: 'bg-rose-50' },
                    { l: '미수 잔금', v: new Intl.NumberFormat('ko-KR', { notation:"compact" }).format(stats.receivable), i: Wallet, c: 'text-amber-600', b: 'bg-amber-50' },
                 ].map((k,i) => (
                    <div key={i} className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center mb-3 ${k.b} ${k.c}`}><k.i size={20}/></div>
                        <div><span className="text-xs font-medium text-slate-400">{k.l}</span><p className="text-2xl font-bold tracking-tight">{k.v}</p></div>
                    </div>
                 ))}
              </div>

              <div className="flex flex-col xl:flex-row gap-4 mb-6 justify-between">
                 <div className="flex flex-wrap gap-2 items-center bg-white p-2 rounded-xl border shadow-sm">
                    <div className="px-3 flex items-center gap-2 text-slate-500 font-bold uppercase text-xs border-r mr-1"><Filter size={14}/>Filter</div>
                    <input type="date" className="bg-slate-50 border rounded px-2 py-1 text-xs" value={filters.startDate} onChange={e=>setFilters({...filters, startDate:e.target.value})} />
                    <span className="text-xs text-slate-400">~</span>
                    <input type="date" className="bg-slate-50 border rounded px-2 py-1 text-xs" value={filters.endDate} onChange={e=>setFilters({...filters, endDate:e.target.value})} />
                    <select className="bg-transparent text-sm font-medium py-1 px-2 cursor-pointer outline-none" value={filters.type} onChange={e=>setFilters({...filters, type:e.target.value})}>
                        <option value="all">구분 전체</option><option value="입금">입금</option><option value="지출">지출</option>
                    </select>
                    <select className="bg-transparent text-sm font-medium py-1 px-2 cursor-pointer outline-none" value={filters.manager} onChange={e=>setFilters({...filters, manager:e.target.value})}>
                        <option value="all">담당자 전체</option><option value="차현지">차현지</option><option value="안세준">안세준</option><option value="정지운">정지운</option>
                    </select>
                 </div>
                 <div className="flex gap-2">
                    <div className="relative group flex-1 xl:w-64">
                        <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"/>
                        <input type="text" className="w-full pl-9 pr-3 py-2.5 bg-white border rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 outline-none" placeholder="검색..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                    </div>
                    <div className="bg-white border p-1 rounded-xl flex">
                        <button onClick={()=>setViewMode('table')} className={`p-2 rounded-lg ${viewMode==='table'?'bg-slate-100':''}`}><TableIcon size={18}/></button>
                        <button onClick={()=>setViewMode('card')} className={`p-2 rounded-lg ${viewMode==='card'?'bg-slate-100':''}`}><LayoutGrid size={18}/></button>
                    </div>
                 </div>
              </div>

              {data.length === 0 ? (
                  <div className="py-20 text-center text-slate-400 bg-white rounded-2xl border border-dashed flex flex-col items-center gap-3">
                      <div className="p-4 bg-slate-50 rounded-full"><Archive size={24}/></div>
                      <p>데이터가 없습니다. 설정에서 시트 URL을 연결해주세요.</p>
                  </div>
              ) : viewMode === 'table' ? (
                  <div className="bg-white rounded-2xl border overflow-hidden shadow-sm">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left whitespace-nowrap">
                        <thead className="bg-slate-50 border-b text-xs uppercase text-slate-500">
                          <tr>
                            <th className="px-4 py-3">No.</th><th className="px-4 py-3">구분</th><th className="px-4 py-3">담당자</th>
                            <th className="px-4 py-3">프로젝트 / 거래처</th><th className="px-4 py-3 text-right">총액</th>
                            <th className="px-4 py-3 text-right bg-slate-50/50">선금</th><th className="px-4 py-3 text-right">중도금</th><th className="px-4 py-3 text-right bg-slate-50/50">잔금</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {filteredData.map(row => (
                            <tr key={row.id} className="hover:bg-slate-50/50">
                               <td className="px-4 py-4 text-xs font-mono text-slate-400">{row.fileNo}</td>
                               <td className="px-4 py-4"><Badge label={row.type}/></td>
                               <td className="px-4 py-4"><Badge label={row.manager} type="manager"/></td>
                               <td className="px-4 py-4"><div className="font-bold text-slate-800">{row.project}</div><div className="text-xs text-slate-500 flex items-center gap-1"><Building2 size={10}/>{row.client}</div></td>
                               <td className="px-4 py-4 text-right font-bold">{formatCurrency(row.amount)}</td>
                               <td className="px-4 py-4 bg-slate-50/50 align-top"><PaymentCell data={row.downPay}/></td>
                               <td className="px-4 py-4 align-top"><PaymentCell data={row.midPay}/></td>
                               <td className="px-4 py-4 bg-slate-50/50 align-top"><PaymentCell data={row.balance}/></td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
              ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-5">
                      {filteredData.map(row => (
                          <div key={row.id} className="bg-white rounded-2xl border p-5 hover:shadow-lg transition-all relative overflow-hidden group">
                              <div className={`absolute left-0 top-0 bottom-0 w-1 ${row.type==='입금'?'bg-indigo-500':row.type==='지출'?'bg-rose-500':'bg-slate-300'}`}></div>
                              <div className="pl-3 mb-4">
                                  <div className="flex justify-between items-start mb-1"><Badge label={row.type}/><span className="text-xs font-mono text-slate-400">No.{row.fileNo}</span></div>
                                  <h3 className="font-bold text-lg leading-snug group-hover:text-indigo-700 transition-colors">{row.project}</h3>
                                  <div className="text-xs text-slate-500 mt-1 flex gap-1 items-center"><Building2 size={12}/> {row.client}</div>
                              </div>
                              <div className="pl-3 grid grid-cols-2 gap-2 mb-4">
                                  <div className="bg-slate-50 p-2 rounded border"><span className="text-[10px] text-slate-400 block">담당자</span><Badge label={row.manager} type="manager"/></div>
                                  <div className="bg-slate-50 p-2 rounded border"><span className="text-[10px] text-slate-400 block">기간</span><span className="text-xs font-mono">{row.startDate}~{row.endDate}</span></div>
                              </div>
                              <div className="pl-3 space-y-2 border-t pt-3">
                                  <div className="flex justify-between font-bold text-sm"><span>총 계약금액</span><span>{formatCurrency(row.amount)}</span></div>
                                  {['선금','중도금','잔금'].map((k,i) => {
                                      const d = k==='선금'?row.downPay:k==='중도금'?row.midPay:row.balance;
                                      if(!d || !d.amount) return null;
                                      return (
                                          <div key={i} className="flex justify-between text-xs items-center">
                                              <div className="flex gap-2 items-center"><span className="w-8 text-slate-400">{k}</span><Badge label={d.status}/><Badge label={d.tax}/></div>
                                              <span className="font-bold text-slate-700">{formatCurrency(d.amount)}</span>
                                          </div>
                                      )
                                  })}
                              </div>
                          </div>
                      ))}
                  </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
